datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

////////////////////
// ENUMS
////////////////////
enum Role {
  STUDENT
  TEACHER
  LAB_ASSISTANT
  PRINCIPAL
  ADMIN
}

enum DifficultyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
}

enum QuizStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum AttemptStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

////////////////////
// MODELS
////////////////////
model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  role      Role
  createdAt DateTime @default(now())

  // Relations
  teacher     Teacher?
  student     Student?
  quizAttempt QuizAttempt[]
}

model Teacher {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  subject   String?
  createdAt DateTime @default(now())

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  practicals Practical[]
  schedules  Schedule[]
  quizzes    Quiz[]
}

model Student {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  grade     String
  createdAt DateTime @default(now())

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizAttempt QuizAttempt[]
}

model Practical {
  id          Int             @id @default(autoincrement())
  title       String
  description String?
  subject     String
  grade       String
  duration    String
  difficulty  DifficultyLevel @default(INTERMEDIATE)
  videoUrl    String?         // URL to video file
  labSheetUrl String?         // URL to PDF file
  thumbnail   String?         // URL to thumbnail image
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  teacherId Int
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  quizzes   Quiz[]
}

model Quiz {
  id           Int          @id @default(autoincrement())
  title        String
  description  String?
  practicalId  Int
  totalMarks   Int          @default(100)
  passingMarks Int          @default(60)
  timeLimit    Int?         // Time limit in minutes
  status       QuizStatus   @default(DRAFT)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  practical   Practical   @relation(fields: [practicalId], references: [id], onDelete: Cascade)
  teacherId   Int
  teacher     Teacher     @relation(fields: [teacherId], references: [id])
  questions   Question[]
  attempts    QuizAttempt[]
}

model Question {
  id            Int          @id @default(autoincrement())
  quizId        Int
  question      String
  type          QuestionType @default(MULTIPLE_CHOICE)
  options       String[]     // JSON array for multiple choice options
  correctAnswer String?      // For multiple choice/true false (single answer)
  // Use Json type for multiple correct answers
  correctAnswers Json?       // For multiple select (stored as JSON array)
  marks         Int          @default(1)
  explanation   String?      // Explanation shown after quiz
  order         Int          @default(0) // For ordering questions
  createdAt     DateTime     @default(now())

  // Relations
  quiz         Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizAttempts QuizAnswer[]
}

model QuizAttempt {
  id            Int           @id @default(autoincrement())
  quizId        Int
  studentId     Int
  totalMarks    Int
  obtainedMarks Int
  percentage    Float
  passed        Boolean
  startedAt     DateTime      @default(now())
  completedAt   DateTime?
  status        AttemptStatus @default(IN_PROGRESS)

  // Relations
  quiz     Quiz        @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student  Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  answers  QuizAnswer[]
}

model QuizAnswer {
  id             Int      @id @default(autoincrement())
  attemptId      Int
  questionId     Int
  answer         String?  // For multiple choice/short answer
  // Use Json type for multiple selected options
  selectedOptions Json?   // For multiple select (stored as JSON array)
  isCorrect      Boolean?
  marksObtained  Int      @default(0)
  feedback       String?

  // Relations
  attempt   QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question  Question    @relation(fields: [questionId], references: [id])
}

model Schedule {
  id          Int      @id @default(autoincrement())
  title       String
  date        DateTime
  description String?
  createdAt   DateTime @default(now())

  // Relations
  teacherId  Int
  teacher    Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
}

// Optional: For file storage management
model FileUpload {
  id          Int      @id @default(autoincrement())
  filename    String
  originalName String
  mimeType    String
  size        Int      // in bytes
  path        String   // Storage path or URL
  type        String   // 'video', 'pdf', 'image'
  practicalId Int?
  uploadedBy  Int
  createdAt   DateTime @default(now())

  // Relations
  practical Practical? @relation(fields: [practicalId], references: [id], onDelete: SetNull)
  user      User      @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)
}